#!/usr/bin/env bash

usage() {
	local old_xtrace
	old_xtrace="$(shopt -po xtrace || :)"
	set +o xtrace

	{
		echo "${script_name} - Play AAC encoded M4A files."
		echo "Usage: ${script_name} [flags] <top-dir | M3U playlist | M4A file>"
		echo "Option flags:"
		echo "  -h --help        - Show this help and exit."
		echo "  -v --verbose     - Verbose execution. Default: '${verbose}'."
		echo "  -g --debug       - Extra verbose execution. Default: '${debug}'."
		echo 'Input:'
		case "${input_type}" in
		m4a_file)
			echo "  m4a file: '${arg_1}'"
			;;
		playlist)
			echo "  playlist: '${arg_1}'"
			;;
		top_dir)
			echo "  top-dir: '${arg_1}'"
			;;
		esac
		echo "Info:"
		print_project_info
	} >&2
	eval "${old_xtrace}"
}

process_opts() {
	local short_opts="hvg"
	local long_opts="help,verbose,debug,recurse-count:"

	local opts
	opts=$(getopt --options ${short_opts} --long ${long_opts} -n "${script_name}" -- "$@")

	eval set -- "${opts}"

	while true ; do
		# echo "${FUNCNAME[0]}: (${#}) '${*}'"
		case "${1}" in
		-h | --help)
			usage=1
			shift
			;;
		-v | --verbose)
			verbose=1
			shift
			;;
		-g | --debug)
			verbose=1
			debug=1
			keep_tmp_dir=1
			set -x
			shift
			;;
		--recurse-count)
			recurse_count="${2}"
			shift 2
			;;
		--)
			shift
			arg_1="${1:-}"
			if [[ ${arg_1} ]]; then
				shift
			fi
			extra_args="${*}"
			break
			;;
		*)
			echo "${script_name}: ERROR: Internal opts: '${*}'" >&2
			exit 1
			;;
		esac
	done
}

last_int=0
on_sigint() {
	local now="$(( SECONDS + 1 ))"
	local delta="$(( now - last_int ))"

	echo

	if [[ ${debug} ]]; then
		echo "${FUNCNAME[0]}: ${now} - ${last_int} = ${delta}" >&2
	fi

	if (( delta < 2 )); then
		echo "${script_name}: Terminating." >&2
		trap - EXIT
		exit 0
	fi
	last_int="${now}"
}

print_playing() {
	local artist=${1}
	local album=${2}
	local fall_back=${3}

	if [[ ${artist} && ${album} ]]; then
		echo "${script_name}: Playing: ${artist}, ${album}"
	elif [[ ${artist} ]]; then
		echo "${script_name}: Playing: ${artist}"
	elif [[ ${album} ]]; then
		echo "${script_name}: Playing: ${album}"
	else
		echo "${script_name}: Playing: ${fall_back}"
	fi
}

play_tracks() {
	local -n _play_tracks__tracks_array="${1}"
	local files_prefix="${2}"

	local in_count="${#_play_tracks__tracks_array[@]}"

	if [[ ${#_play_tracks__tracks_array[@]} == 0 ]]; then
		echo "${script_name}: INFO: No input files found." >&2
		return
	fi

	if [[ ${verbose} ]]; then
		echo "${script_name}: Playing ${in_count} input files."
	fi

	local id
	local file

	for (( id = 1; id <= ${in_count}; id++ )); do
		file="${_play_tracks__tracks_array[$(( id - 1 ))]}"
		echo "${id}/${in_count}: '${files_prefix}${file}'"
		"${ffplay}" -loglevel quiet -nodisp -autoexit "${files_prefix}${file}" > /dev/null || :
	done
}

play_m4a() {
	local m4a_file="${1}"

	check_file 'm4a file' "${m4a_file}"

	local -a tracks_array=("${m4a_file}")

	local -A tags
	m4a_fill_tag_set "${m4a_file}" tags

	print_playing "${tags[ARTIST]}" "${tags[ALBUM]}" "'${m4a_file}'"
	play_tracks tracks_array ''
}

play_playlist() {
	local playlist_file="${1}"

	check_file 'playlist' "${playlist_file}"

	local -a lines_array
	local -a tracks_array=()

	readarray -t lines_array < "${playlist_file}"

	local line_count="${#lines_array[@]}"
	local artist=''
	local album=''

	for (( id = 1; id <= ${line_count}; id++ )); do
		line="${lines_array[$(( id - 1 ))]}"

		if [[ "${line::1}" = '#' ]]; then
			if [[ ${verbose} ]]; then
				echo "${id}: (comment) = '${line}'" >&2
			fi
			if [[ "${line::8}" = '#EXTART:' ]]; then
				artist="${line:9}"
			fi
			if [[ "${line::8}" = '#EXTALB:' ]]; then
				album="${line:9}"
			fi
			continue
		fi

		if [[ ! "${line}" ]]; then
			if [[ ${verbose} ]]; then
				echo "${id}: (blank) = '${line}'" >&2
			fi
			continue
		fi

		if [[ "${line: -4:4}" = '.m4a' ]]; then
			if [[ ${verbose} ]]; then
				echo "${id}: (track) = '${line}'" >&2
			fi

			tracks_array=("${tracks_array[@]}" "${line}")
			continue
		fi

		if [[ "${line: -4:4}" = '.m3u' ]]; then
			if [[ ${verbose} ]]; then
				echo "${id}: (playlist) = '${line}'" >&2
			fi

			"${SCRIPT_TOP}/${script_name}" ${verbose:+--verbose} ${debug:+--debug} --recurse-count="$(( recurse_count + 1 ))" "${line}"
			continue
		fi

		echo "${script_name}: ERROR: ${id}: Unknown line type: '${line}'." >&2
	done

	if [[ ! "${tracks_array[@]}" ]]; then
		return
	fi

	if [[ -f "${tracks_array[0]}" ]]; then
		files_prefix=''
	elif [[ -f "${playlist_file%/*}/${tracks_array[0]}" ]]; then
		files_prefix="${playlist_file%/*}/"
	else
		echo "${script_name}: ERROR: Unknown files_prefix: playlist = '${playlist_file}', track = '${tracks_array[0]}'" >&2
	fi

	print_playing "${artist}" "${album}" "'${playlist_file}'"
	play_tracks tracks_array "${files_prefix}"
}

play_top_dir() {
	local top_dir="${1}"

	check_top_dir "${top_dir}"

	local -a tracks_array

	readarray -t tracks_array < <(find "${top_dir}" -type f -name '*.m4a' | sort \
		|| { echo "${script_name}: ERROR: tracks_array find failed, function=${FUNCNAME[0]:-main}, line=${LINENO}, result=${?}" >&2; \
		kill -SIGUSR1 $$; } )

	local -A tags

	if [[ ${#tracks_array[@]} != 0 ]]; then
		m4a_fill_tag_set "${tracks_array[0]}" tags
		print_playing "${tags[ARTIST]}" "${tags[ALBUM]}" "'${top_dir}'"
	fi

	play_tracks tracks_array ''
}

#===============================================================================
export PS4='\[\e[0;33m\]+ ${BASH_SOURCE##*/}:${LINENO}:(${FUNCNAME[0]:-main}):\[\e[0m\] '

script_name="${0##*/}"

SECONDS=0
start_time="$(date +%Y.%m.%d-%H.%M.%S)"

real_source="$(realpath "${BASH_SOURCE}")"
SCRIPT_TOP="$(realpath "${SCRIPT_TOP:-${real_source%/*}}")"

trap "on_exit 'Failed'" EXIT
trap 'on_err ${FUNCNAME[0]:-main} ${LINENO} ${?}' ERR
trap 'on_err SIGUSR1 ? 3' SIGUSR1
trap 'on_sigint' SIGINT

set -eE
set -o pipefail
set -o nounset

source "${SCRIPT_TOP}/audx-lib.sh"

usage=''
verbose=''
debug=''
recurse_count=''
arg_1=''

process_opts "${@}"

if [[ -f "${HOME}/.audx.conf" ]]; then
	source "${HOME}/.audx.conf"
fi

input_type=''

if [[ -d "${arg_1}" ]]; then
	input_type='top_dir'
elif [[ -f "${arg_1}" && "${arg_1##*.}" == 'm3u' ]]; then
	input_type='playlist'
elif [[ -f "${arg_1}" && "${arg_1##*.}" == 'm4a' ]]; then
	input_type='m4a_file'
fi

if [[ ${usage} ]]; then
	usage
	trap - EXIT
	exit 0
fi

print_project_banner

if [[ ${extra_args} ]]; then
	set +o xtrace
	echo "${script_name}: ERROR: Got extra args: '${extra_args}'." >&2
	usage
	exit 1
fi

if [[ ${verbose} ]]; then
	echo "${script_name}: INFO: Recurse count = '${recurse_count}'."
fi

if (( recurse_count > 5 )); then
	echo "${script_name}: ERROR: Hit recurse_count: '${recurse_count}'" >&2
	exit 1
fi

exiftool="${exiftool:-exiftool}"
check_program "exiftool" "${exiftool}"

ffplay="${ffplay:-ffplay}"
check_program "ffplay" "${ffplay}"

if [[ ! ${arg_1} ]]; then
	set +o xtrace
	echo "${script_name}: ERROR: No input files." >&2
	usage
	exit 1
fi

arg_1="$(realpath -e "${arg_1}")"

case "${input_type}" in
m4a_file)
	play_m4a "${arg_1}"
	;;
playlist)
	play_playlist "${arg_1}"

	;;
top_dir)
	play_top_dir "${arg_1}"
	;;
*)
	echo "${script_name}: ERROR: Unknown input type: '${arg_1}'" >&2
	usage
	exit 1
	;;
esac

trap "on_exit 'Success'" EXIT
exit 0
